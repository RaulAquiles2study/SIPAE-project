<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIPAE - PRINCIPAL</title>
    <link rel="stylesheet" href="../css/estilo-novo.css"/>
    <link rel="stylesheet" href="../css/estilo-materiais.css"/>
</head>
<body>
 <div class="container">
  <aside class="menu-lateral">
  </aside>

  <main class="conteudo">
   <header class="cabecalho">
    <h1>SIPAE</h1>
    <h2 id="bleh"></h2>
    <h2 id="extras"></h2>
   </header>
   <section class="contents">
   </section>
  </main>
 </div>
 <script type="module" src="../script.js"></script>
</body>
</html>
<script type="module">
import {criarSidebar,makeRequest,redirecionar,getUser} from '../script.js'
document.querySelector('.menu-lateral').appendChild(await criarSidebar())
let canClickShit = true;
const query = new URLSearchParams(window.location.search);
const user = await getUser()

function getStatus(s){
 switch (s) {
  case 0:return 'Disponível';
  case 1:return 'Manutenção';
  case 2:return 'Quebrado';
 }
}
let selection = new Set();

let doinField = {}
let doinObj = {}
let doinMain = {}
let doinDel = {}
let doinCost = {}
async function edit(){
    let did = false;
    if (Object.keys(doinField).length>0){
     console.log(doinField)
        makeRequest('tipoObjetos/field',null,'PUT',true,doinField)
        doinField = {}
        did = true
    }
    if (Object.keys(doinObj).length>0){
        makeRequest('objetos/field',null,'PUT',true,doinObj)
        doinObj = {}
        did = true
    }
    if (Object.keys(doinMain).length>0){
     makeRequest('manutencoes',null,'POST',true,doinMain)
     doinMain = {};
     did = true;
    }
    if (Object.keys(doinDel).length>0){
     makeRequest('objetos',{selection:doinDel.selection},'DELETE',true)
     doinDel = {};
     did = true;
    }
    if (Object.keys(doinCost).length>0){
     makeRequest('objetos/cost',null,'PUT',true,doinCost)
     doinCost = {};
     did = true;
    }
    if (did){
     await reload()
    }
}
setInterval(edit,100);
let loading = false;
async function reload(){
 if (loading) return;
 bgDiv.style.display = 'none';
 loading = true;
 canClickShit = true;
 try{
  document.getElementsByClassName('contents')[0].removeChild(document.getElementsByClassName('tabela')[0])
 }catch(e){/*do nothing lmao*/}
 const table = document.createElement('table');
 table.className = 'tabela'
 const fields = document.createElement('tr');
 const cat = (await makeRequest('tipoObjetos/'+query.get('id'))).result
 document.getElementById('bleh').innerText = cat.name
 const sel = document.createElement('td')
 sel.innerText = 'Seleção'
 fields.appendChild(sel)
 const num = document.createElement('td')
 num.innerText = '#'
 fields.appendChild(num)
 const stat = document.createElement('td')
 stat.innerText = 'Status'
 fields.appendChild(stat)
 const val = document.createElement('td')
 val.innerText = 'Valor Unitário'
 fields.appendChild(val)
 const data = String(cat.customData).split(',')

 for (const field of data){
  if (field == '') continue;
  const f = document.createElement('td')
  if (user.rank>4){
   const del = document.createElement('img')
   del.src = '../delete.png'
   del.width = 20;
   del.height = 20;
   del.onmouseover = ()=>{
    document.body.style.cursor = 'pointer'
   }
   del.onmouseout = ()=>{
    document.body.style.cursor = 'auto'
   }
   del.onclick = async()=>{
    if (!canClickShit) return;
    canClickShit = false;
    if (confirm('Gostaria de deletar esse campo?'))
        await makeRequest(`tipoObjetos/${query.get('id')}/field/${data.indexOf(field)}`,null,'DELETE',true)

        await reload()
    document.body.style.cursor = 'auto'
   }
   f.appendChild(del)
   const edt = document.createElement('img')
   edt.src = '../edit.png'
   edt.width = 20;
   edt.height = 20;
   edt.onmouseover = ()=>{
    document.body.style.cursor = 'pointer'
   }
   edt.onmouseout = ()=>{
    document.body.style.cursor = 'auto'
   }
   edt.onclick = async()=>{
    if (!canClickShit) return;
    canClickShit = false;
    f.removeChild(del)
    f.removeChild(b)
    f.removeChild(edt)
    const edtI = document.createElement('input')
    edtI.type = 'text';
    edtI.value = (field=='Novo Campo'?'':field);
    document.body.style.cursor = 'auto';
    let block = false;
    edtI.onkeydown = async(event)=>{
    if (event.key!=='Enter') return;
        if (block) return;
        block = true;
        if (data.includes(edtI.value)){
            alert('Já existe um campo com esse nome!');
            await reload()
            return;
        }
        if (edtI.value.trim().length <1){
            alert('Campo não pode ser vazio!')
            await reload()
            return;
        }
        if (edtI.value.length>20){
            alert('Campo não deve ser maior que 20 caracteres!')
            await reload();
            return;
        }
        if (edtI.value.includes(',')){
            alert('Campos não podem incluir vírgula!');
            await reload()
            return;
        }
        doinField = {tid:query.get('id'),fid:data.indexOf(field),fn:edtI.value}
    }
    edtI.onblur = async(event)=>{
        if (block) return;
        block = true;
        if (data.includes(edtI.value)){
            alert('Já existe um campo com esse nome!');
            await reload()
            return;
        }
        if (edtI.value.length>20){
            alert('Campo não deve ser maior que 20 caracteres!')
            await reload();
            return;
        }
        if (edtI.value.trim().length <1){
            alert('Campo não pode ser vazio!')
            await reload()
            return;
        }
        if (edtI.value.includes(',')){
            alert('Campos não podem incluir vírgula!');
            await reload()
            return;
        }
        doinField = {tid:query.get('id'),fid:data.indexOf(field),fn:edtI.value}
    }
    f.appendChild(edtI)
    edtI.focus();
   }
   f.appendChild(edt)
  }

  const b = document.createElement('text')
  b.innerText = field
  f.appendChild(b)
  fields.appendChild(f);
 }
 const newfield = document.createElement('td')
 const newfieldBtn = document.createElement('button')
 newfieldBtn.type = 'button';
 newfieldBtn.innerText = 'Novo Campo'
newfieldBtn.className = 'botunn'


 newfieldBtn.onclick = async()=>{
  if (!canClickShit) return;
  if (data.length==15){
    if (!confirm('Você está criando uma quantidade grande de campos. Tem certeza que quer prosseguir?'))
        return;
  }
  canClickShit = false;
  await makeRequest(`tipoObjetos/${query.get('id')}/field`,null,'POST',true)
  await reload()
 }

 newfield.appendChild(newfieldBtn)
 fields.appendChild(newfield)

 table.append(fields);
 
 await generateObjects(cat.children,table);

 const newObjRow = document.createElement('tr')
 const newObjDat = document.createElement('td')
 const newObjBtn = document.createElement('button')
 newObjBtn.type = 'button';
 newObjBtn.innerText='Novo Objeto'
 newObjBtn.className = 'botunn'
 newObjBtn.style.background = 'linear-gradient(135deg, #00FF44, #008822)'
 newObjBtn.onclick = async()=>{
  if (!canClickShit) return;
  canClickShit = false;

  await makeRequest('objetos',null,'POST',true,{id:query.get('id')})
  await reload()
 }
 newObjDat.appendChild(newObjBtn)
 newObjRow.appendChild(newObjDat)

 const delObjDat = document.createElement('td')
 const delObjBtn = document.createElement('button')
 delObjBtn.type = 'button';
 delObjBtn.innerText='Deletar Objeto'
 delObjBtn.className = 'botunn'
 delObjBtn.style.background = 'linear-gradient(135deg, #FF4444, #882222)'
 delObjBtn.onclick = async()=>{
  if (!canClickShit) return;
  canClickShit = false;
  const selects = Array.from(selection)
  if (selects.length<1){
   alert('Por favor, selecione ao menos um objeto')
   await reload();
   return;
  }
  if (confirm(`Gostaria de deletar ${selects.length>1?'esses objetos':'esse objeto'}?`))
   doinDel = {selection:Array.from(selection).join(',')}
  else
   await reload();
 }
 delObjDat.appendChild(delObjBtn)
 newObjRow.appendChild(delObjDat)
 
 const manObjDat = document.createElement('td')
 const manObjBtn = document.createElement('button')
 manObjBtn.type = 'button';
 manObjBtn.className = 'botunn'
 manObjBtn.innerText='Enviar à Manutenção'
 manObjBtn.onclick = async()=>{
  if (!canClickShit) return;
  canClickShit = false;
  const selects = Array.from(selection)
  if (selects.length<1){
   alert('Por favor, selecione ao menos um objeto')
   await reload();
   return;
  }
  bgDiv.style.display='flex'
 }
 manObjDat.appendChild(manObjBtn)
 newObjRow.appendChild(manObjDat)

 table.appendChild(newObjRow)

 document.getElementsByClassName('contents')[0].appendChild(table)
 loading = false;
}
















async function generateObjects(objs,table){
 let i = 0
 for (const item of objs){
  const row = document.createElement('tr');
  const data = item.customData.split(',');
  const sel = document.createElement('td');
  const checky = document.createElement('input');
  checky.type = 'checkbox';
  checky.checked = selection.has(item.ID);
  checky.style.width = '30px';
  checky.style.height = '30px';
  checky.onchange = ()=>{
   if (checky.checked)
    selection.add(item.ID);
   else
    selection.delete(item.ID);
  }
  sel.appendChild(checky);
  row.appendChild(sel);

  const num = document.createElement('td');
  num.innerText = ++i+''
  row.appendChild(num);

  const stat = document.createElement('td');
  const statSelect = document.createElement('select');
  if (item.estado==1) statSelect.disabled = true;
  const o0 = document.createElement('option');
  const o1 = document.createElement('option');
  const o2 = document.createElement('option');
  o0.innerText = 'Manutenção';
  o0.disabled = true;
  o0.hidden = true;
  o1.innerText = 'Disponível';
  o2.innerText = 'Quebrado';
  statSelect.appendChild(o1)
  statSelect.appendChild(o2)
  statSelect.appendChild(o0)
  statSelect.value = getStatus(item.estado)
  statSelect.onchange = async()=>{
   if (statSelect.selectedIndex==0)
    await makeRequest('objetos/state',null,'PUT',true,{id:item.ID,np:0})
   else
    await makeRequest('objetos/state',null,'PUT',true,{id:item.ID,np:2})
   await reload();
  }
  stat.appendChild(statSelect);
  row.appendChild(stat)
  const valImg = document.createElement('img')
  const val = document.createElement('td')
  valImg.src = '../edit.png';
  valImg.width = 20;
  valImg.height = 20;

  valImg.onclick = async()=>{
    if (!canClickShit) return;
    canClickShit = false;
    val.removeChild(valImg)
    val.removeChild(valTxt)
    const edtI = document.createElement('input')
    edtI.type = 'text'
    edtI.value = (item.valor==0?'':item.valor).toString()
    document.body.style.cursor = 'auto'
    edtI.oninput = ()=>{
      edtI.value = edtI.value.replace(',','.')
      edtI.value = edtI.value.replace(/[^\d\.]+/g,'')
      edtI.value = edtI.value.replace(/(.*\..*)([^\d])+/g,'$1')
    }
    let doin = false
    edtI.onkeydown = async(event)=>{
     if (event.key!=='Enter' || doin) return;
     doin = true;
     if (edtI.value.trim().length <1){
      alert('Valor não pode ser vazio!')
      await reload()
      return;
     }
     const val = parseFloat(edtI.value)
     if (val>10000000000){
      alert('Valor não pode ser maior que 10000000000!')
      await reload();
      return;
     }
     if (val<1){
      alert('Valor não pode ser menor que 1!')
      await reload();
      return;
     }
     doinCost = {id:item.ID,valor:parseFloat(edtI.value)}
    }
    edtI.onblur = async(event)=>{
     if (doin) return;
     doin = true;
     if (edtI.value.trim().length <1){
      alert('Valor não pode ser vazio!')
      await reload()
      return;
     }
     const val = parseFloat(edtI.value)
     if (val>10000000000){
      alert('Valor não pode ser maior que 10000000000!')
      await reload();
      return;
     }
     if (val<1){
      alert('Valor não pode ser menor que 1!')
      await reload();
      return;
     }
     doinCost = {id:item.ID,valor:parseFloat(edtI.value)}
    }
    val.appendChild(edtI)
    edtI.focus();
   }

  valImg.onmouseover = ()=>{
   document.body.style.cursor = 'pointer'
  }
  valImg.onmouseout = ()=>{
   document.body.style.cursor = 'auto'
  }

  val.appendChild(valImg);

  const valTxt = document.createElement('text');
  valTxt.innerText = (item.valor??0)+' R$';
  val.appendChild(valTxt);
  console.log(item)

  row.appendChild(val)
  for (const index in data){
   const field = data[index]
   if (field=='') continue;
   const f = document.createElement('td')
   const d = document.createElement('text')
   d.innerText = field;
   const ed = document.createElement('img')
   ed.src = '../edit.png'
   ed.width = 20;
   ed.height = 20;
   ed.onmouseover = ()=>{
    document.body.style.cursor = 'pointer'
   }
   ed.onmouseout = ()=>{
    document.body.style.cursor = 'auto'
   }
   ed.onclick = async()=>{
    if (!canClickShit) return;
    canClickShit = false;
    f.removeChild(d)
    f.removeChild(ed)
    const edtI = document.createElement('input')
    edtI.type = 'text'
    edtI.value = (field=='(Vazio)'?'':field);
    document.body.style.cursor = 'auto'
    edtI.onkeydown = async(event)=>{
     if (event.key!=='Enter') return;
     if (edtI.value.includes(',')){
        alert('Campos não podem incluir vírgula!');
        await reload();
        return;
    }
    if (edtI.value.length>20){
            alert('Campo não deve ser maior que 20 caracteres!')
            await reload();
            return;
        }
    if (edtI.value.trim().length <1){
            alert('Campo não pode ser vazio!')
            await reload()
            return;
        }
    doinObj = {id:item.ID,fid:index,fv:edtI.value}
    }
    edtI.onblur = async(event)=>{
        if (edtI.value.includes(',')){
            alert('Campos não podem incluir vírgula!');
            return;
        }
        if (edtI.value.length>20){
            alert('Campo não deve ser maior que 20 caracteres!')
            await reload();
            return;
        }
        if (edtI.value.trim().length <1){
            alert('Campo não pode ser vazio!')
            await reload()
            return;
        }
        doinObj ={id:item.ID,fid:index,fv:edtI.value}
    }
    f.appendChild(edtI)
    edtI.focus();
   }
   f.appendChild(ed)
   f.appendChild(d)
   row.appendChild(f);
  }
  table.appendChild(row)
 }
}















const bgDiv = document.createElement('div')
bgDiv.style.display='none';
bgDiv.className = 'modalBG';

const modalDiv = document.createElement('div')
modalDiv.className = 'modalWindow';

const f = document.createElement('form')

const valLabel = document.createElement('label')
valLabel.htmlFor = 'val'
valLabel.innerText = 'Valor da manutenção';

f.appendChild(valLabel);

const valInput = document.createElement('input')
valInput.name = 'val';
valInput.placeholder = 'Valor...'
f.appendChild(valInput)
valInput.oninput = ()=>{
 valInput.value = valInput.value.replace(',','.')
 valInput.value = valInput.value.replace(/[^\d\.]+/g,'')
 valInput.value = valInput.value.replace(/(.*\..*)([^\d])+/g,'$1')
}

const descLabel = document.createElement('label')
descLabel.htmlFor = 'desc'
descLabel.innerText = 'Descrição do problema';

f.appendChild(descLabel);

const descInput = document.createElement('textarea');
descInput.name = 'desc';
descInput.placeholder = 'Descrição...';
f.appendChild(descInput);

const datLabel = document.createElement('label')
datLabel.htmlFor = 'dat'
datLabel.innerText = 'Retorno esperado da manutenção';

f.appendChild(datLabel);

const dateInput = document.createElement('input')
dateInput.name = 'dat'
dateInput.type = 'date';
f.appendChild(dateInput)

const sdat = document.createElement('label')
sdat.htmlFor = 'deet'
sdat.innerText = 'Pedido da manutenção';

f.appendChild(sdat);

const sdateInput = document.createElement('input')
sdateInput.name = 'deet'
sdateInput.type = 'date';
f.appendChild(sdateInput)

const brow = document.createElement('div')
brow.className = 'buttonRow'

const cancel = document.createElement('button');
cancel.className = 'botunn';
cancel.type = 'button';
cancel.innerText = 'cancelar';
cancel.addEventListener('click',async (event)=>{
 event.preventDefault();
 bgDiv.style.display = 'none';
 valInput.value=''
 dateInput.value=''
 await reload();
})
brow.appendChild(cancel);

const confurm = document.createElement('button');
confurm.type = 'button';
confurm.className = 'botunn';
confurm.innerText = 'Confirmar';
confurm.addEventListener('click',async (event)=>{
 event.preventDefault();
 if (valInput.value==''){
  alert('Valor não pode ser vazio!')
  await reload();
  return;
 }
 const val = parseFloat(valInput.value)
 if (val<1){
  alert('Valor não pode menor que 1!')
  await reload();
  return;
 }
 if (!dateInput.valueAsDate){
  alert('Data inválida!')
  await reload();
  return;
 }
 if (dateInput.valueAsDate.getTime()<new Date().getTime()){
  alert('Data não pode estar no passado!')
  await reload();
  return;
 }
 bgDiv.style.display = 'none';
 doinMain = {objIDs:Array.from(selection),desc:descInput.value,calldate:sdateInput.valueAsDate.toISOString(),value:parseInt(valInput.value),data:dateInput.valueAsDate.toISOString()}
})
brow.appendChild(confurm);

f.appendChild(brow)
modalDiv.appendChild(f)
modalDiv.addEventListener('click',(event)=>{
 event.stopPropagation();
})

bgDiv.appendChild(modalDiv)

bgDiv.onclick = async()=>{
 bgDiv.style.display = 'none';
 valInput.value=''
 dateInput.value=''
 await reload();
}

document.querySelector('.container').appendChild(bgDiv)
await reload()
</script>